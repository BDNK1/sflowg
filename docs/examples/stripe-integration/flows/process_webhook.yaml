id: process_webhook

# Process Stripe webhook events:
# 1. Verify webhook signature
# 2. Route by event type:
#    - payment_intent.succeeded  -> status 'succeeded'
#    - payment_intent.payment_failed -> status 'failed'
#    - payment_intent.canceled   -> status 'canceled'
# 3. Update payment in database
# 4. Return acknowledgment

entrypoint:
  type: http
  config:
    method: post
    path: /api/webhooks/stripe
    headers:
      - Stripe-Signature
    body:
      type: json

steps:
  # Verify webhook signature
  - id: verify_signature
    type: signature-verifier.verifySignature
    args:
      signature: request.headers.Stripe-Signature
      payload: request.rawBody

  - id: check_signature
    type: switch
    args:
      signature_invalid: verify_signature.result.valid == false
      signature_valid: verify_signature.result.valid == true

  # Handle invalid signature
  - id: signature_invalid
    type: assign
    args:
      error_response:
        error: '"invalid_signature"'
        message: verify_signature.result.error

  # Extract webhook event data
  - id: signature_valid
    type: assign
    args:
      event_id: request.body.id
      event_type: request.body.type
      payment_intent_id: request.body.data?.object?.id
      payment_intent_status: request.body.data?.object?.status
      payment_id: request.body.data?.object?.metadata?.payment_id
      amount: request.body.data?.object?.amount
      currency: request.body.data?.object?.currency
      is_handled_event: >
        request.body.type == "payment_intent.succeeded" ||
        request.body.type == "payment_intent.payment_failed" ||
        request.body.type == "payment_intent.canceled"

  # Route based on event type
  - id: route_event
    type: switch
    condition: signature_valid.event_type != null
    args:
      handle_succeeded: signature_valid.event_type == "payment_intent.succeeded"
      handle_failed: signature_valid.event_type == "payment_intent.payment_failed"
      handle_canceled: signature_valid.event_type == "payment_intent.canceled"
      build_response: signature_valid.is_handled_event != true

  # Handle payment_intent.succeeded
  - id: handle_succeeded
    condition: signature_valid.event_type == "payment_intent.succeeded"
    type: postgres.exec
    args:
      query: >
        "UPDATE payments
        SET status = $1, stripe_status = $2, updated_at = NOW()
        WHERE stripe_payment_intent_id = $3"
      params:
        - '"succeeded"'
        - signature_valid.payment_intent_status
        - signature_valid.payment_intent_id

  # Handle payment_intent.payment_failed
  - id: handle_failed
    condition: signature_valid.event_type == "payment_intent.payment_failed"
    type: assign
    args:
      failure_message: 'request.body.data?.object?.last_payment_error?.message ?? "Payment failed"'
      failure_code: 'request.body.data?.object?.last_payment_error?.code ?? "unknown"'

  - id: update_failed
    type: postgres.exec
    condition: handle_failed.failure_message != null
    args:
      query: >
        "UPDATE payments
        SET status = $1, stripe_status = $2,
        error_message = $3, error_code = $4, updated_at = NOW()
        WHERE stripe_payment_intent_id = $5"
      params:
        - '"failed"'
        - signature_valid.payment_intent_status
        - handle_failed.failure_message
        - handle_failed.failure_code
        - signature_valid.payment_intent_id

  # Handle payment_intent.canceled
  - id: handle_canceled
    condition: signature_valid.event_type == "payment_intent.canceled"
    type: postgres.exec
    args:
      query: >
        "UPDATE payments
        SET status = $1, stripe_status = $2, updated_at = NOW()
        WHERE stripe_payment_intent_id = $3"
      params:
        - '"canceled"'
        - signature_valid.payment_intent_status
        - signature_valid.payment_intent_id

  # Build unified response (replaces per-branch response steps)
  - id: build_response
    type: assign
    condition: signature_valid.event_type != null
    args:
      response:
        received: true
        event_id: signature_valid.event_id
        event_type: signature_valid.event_type
        payment_intent_id: signature_valid.payment_intent_id
        status: >
          handle_succeeded.result != null ? "succeeded" :
          update_failed.result != null ? "failed" :
          handle_canceled.result != null ? "canceled" :
          "not_handled"
        rows_updated: >
          handle_succeeded.result?.affected_rows ??
          update_failed.result?.affected_rows ??
          handle_canceled.result?.affected_rows

  # Determine final response
  - id: final_response
    type: assign
    args:
      response: 'signature_invalid.error_response ?? build_response.response'
      status_code: 'signature_invalid.error_response != null ? 400 : 200'

# Return 400 for invalid signature, 200 for valid
# Stripe will retry if we return non-2xx
return:
  type: http.json
  args:
    status: final_response.status_code
    body: final_response.response
