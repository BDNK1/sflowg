id: create_payment

# Create a new payment:
# 1. Store payment info in database (pending)
# 2. Create PaymentIntent with Stripe API
# 3. Update payment with Stripe response
# 4. Return client_secret for frontend

entrypoint:
  type: http
  config:
    method: post
    path: /api/payments
    headers:
      - X-Request-ID
    body:
      type: json

steps:
  # ========================================
  # STEP 1: Extract and validate request data
  # ========================================
  - id: extract_request
    type: assign
    args:
      # Amount in cents (Stripe requires cents)
      amount: request.body.amount
      currency: 'request.body.currency ?? properties.default_currency'
      description: 'request.body.description ?? "Payment"'
      customer_email: request.body.customer_email
      customer_name: 'request.body.customer_name ?? ""'
      metadata_order_id: 'request.body.metadata?.order_id ?? ""'
      request_id: 'request.headers.X-Request-ID ?? ""'

  # ========================================
  # STEP 2: Validate amount
  # ========================================
  - id: validate_amount
    type: switch
    args:
      invalid_amount: extract_request.amount == null || extract_request.amount < 50
      valid_amount: extract_request.amount != null && extract_request.amount >= 50

  - id: invalid_amount
    type: assign
    args:
      error_response:
        success: false
        error:
          code: '"invalid_amount"'
          message: '"Amount must be at least 50 cents"'

  # ========================================
  # STEP 3: Insert payment record (pending)
  # ========================================
  - id: valid_amount
    type: postgres.get
    args:
      query: '"INSERT INTO payments (amount, currency, description, customer_email, customer_name, metadata_order_id, status, created_at) VALUES ($1, $2, $3, $4, $5, $6, $7, NOW()) RETURNING id, created_at"'
      params:
        - extract_request.amount
        - extract_request.currency
        - extract_request.description
        - extract_request.customer_email
        - extract_request.customer_name
        - extract_request.metadata_order_id
        - "'pending'"

  - id: store_payment_id
    type: assign
    args:
      payment_id: valid_amount.result.row.id
      created_at: valid_amount.result.row.created_at

  # ========================================
  # STEP 4: Create Stripe PaymentIntent
  # ========================================
  - id: create_payment_intent
    type: http.request
    args:
      url: 'properties.stripe_api_url + "/payment_intents"'
      method: '"POST"'
      content_type: '"form"'
      headers:
        Authorization: '"Basic " + base64_encode(properties.stripe_secret_key + ":")'
      body:
        amount: extract_request.amount
        currency: extract_request.currency
        description: extract_request.description
        receipt_email: extract_request.customer_email
        metadata:
          payment_id: store_payment_id.payment_id
          order_id: extract_request.metadata_order_id

  # ========================================
  # STEP 5: Check Stripe response
  # ========================================
  - id: check_stripe_response
    type: switch
    args:
      stripe_success: create_payment_intent.result.status_code == 200
      stripe_error: create_payment_intent.result.status_code != 200

  # ========================================
  # STEP 6a: Handle Stripe error
  # ========================================
  - id: stripe_error
    type: assign
    args:
      stripe_error_type: 'create_payment_intent.result.body.error?.type ?? "unknown"'
      stripe_error_message: 'create_payment_intent.result.body.error?.message ?? "Stripe API error"'

  - id: update_payment_failed
    type: postgres.exec
    condition: stripe_error.stripe_error_type != null
    args:
      query: '"UPDATE payments SET status = $1, error_message = $2, updated_at = NOW() WHERE id = $3"'
      params:
        - '"failed"'
        - stripe_error.stripe_error_message
        - store_payment_id.payment_id

  - id: error_response
    type: assign
    condition: stripe_error.stripe_error_type != null
    args:
      error_response:
        success: false
        error:
          code: stripe_error.stripe_error_type
          message: stripe_error.stripe_error_message
        payment_id: store_payment_id.payment_id

  # ========================================
  # STEP 6b: Handle Stripe success
  # ========================================
  - id: stripe_success
    type: assign
    args:
      payment_intent_id: create_payment_intent.result.body.id
      client_secret: create_payment_intent.result.body.client_secret
      stripe_status: create_payment_intent.result.body.status

  - id: update_payment_success
    type: postgres.exec
    condition: stripe_success.payment_intent_id != null
    args:
      query: '"UPDATE payments SET stripe_payment_intent_id = $1, stripe_client_secret = $2, stripe_status = $3, status = $4, updated_at = NOW() WHERE id = $5"'
      params:
        - stripe_success.payment_intent_id
        - stripe_success.client_secret
        - stripe_success.stripe_status
        - '"requires_payment_method"'
        - store_payment_id.payment_id

  # ========================================
  # STEP 7: Build success response
  # ========================================
  - id: success_response
    type: assign
    condition: stripe_success.payment_intent_id != null
    args:
      success_response:
        success: true
        data:
          payment_id: store_payment_id.payment_id
          client_secret: stripe_success.client_secret
          payment_intent_id: stripe_success.payment_intent_id
          status: stripe_success.stripe_status
          amount: extract_request.amount
          currency: extract_request.currency
          checkout_url: '"http://localhost:8080/checkout/" + string(store_payment_id.payment_id)'

  # ========================================
  # STEP 8: Determine final response
  # ========================================
  - id: build_final_response
    type: assign
    args:
      is_success: stripe_success.payment_intent_id != null
      response_body: 'success_response.success_response ?? error_response.error_response'
      status_code: 'stripe_success.payment_intent_id != null ? 201 : 400'

return:
  type: http.response
  args:
    # If invalid_amount step ran, its error_response exists; otherwise use build_final_response
    status: 'invalid_amount.error_response != null ? 400 : (build_final_response.status_code ?? 500)'
    headers:
      X-Payment-ID: 'string(store_payment_id.payment_id ?? "")'
    body: 'invalid_amount.error_response ?? build_final_response.response_body'