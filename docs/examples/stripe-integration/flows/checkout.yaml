id: checkout

# Unified checkout flow that handles:
# 1. Initial checkout page: GET /checkout/:payment_id
# 2. Success page after Stripe redirect: GET /checkout/:payment_id?redirect_status=succeeded&payment_intent=...

entrypoint:
  type: http
  config:
    method: get
    path: /checkout/:payment_id
    pathVariables:
      - payment_id
    queryParameters:
      - redirect_status
      - payment_intent

steps:
  # Extract payment_id and query params
  - id: extract_params
    type: assign
    args:
      payment_id: request.pathVariables.payment_id
      redirect_status: request.queryParameters.redirect_status
      payment_intent: request.queryParameters.payment_intent
      has_redirect_params: 'request.queryParameters.redirect_status != null && request.queryParameters.redirect_status != ""'

  # Fetch payment from database
  - id: get_payment
    type: postgres.get
    args:
      query: >
        "SELECT id, amount, currency, stripe_client_secret,
        stripe_payment_intent_id, status
        FROM payments WHERE id = $1"
      params:
        - extract_params.payment_id

  # Check if payment exists
  - id: check_payment
    type: switch
    args:
      payment_not_found: get_payment.result.found == false
      payment_found: get_payment.result.found == true

  # Handle payment not found
  - id: payment_not_found
    type: assign
    args:
      error_html: >
        "<html><body><h1>Payment Not Found</h1>
        <p>Payment ID: " + string(extract_params.payment_id) +
        " does not exist.</p></body></html>"

  # Extract payment details and compute final-status flag
  - id: payment_found
    type: assign
    args:
      payment_id: get_payment.result.row.id
      amount: get_payment.result.row.amount
      currency: get_payment.result.row.currency
      client_secret: get_payment.result.row.stripe_client_secret
      status: get_payment.result.row.status
      is_final: >
        get_payment.result.row.status == "succeeded" ||
        get_payment.result.row.status == "failed" ||
        get_payment.result.row.status == "canceled"

  # Route: final states -> result page, pending -> checkout form
  - id: route_by_status
    type: switch
    condition: payment_found.status != null
    args:
      show_result: payment_found.is_final == true
      show_checkout: payment_found.is_final != true

  # Render result page (payment completed)
  - id: show_result
    condition: payment_found.is_final == true
    type: checkout.renderSuccess
    args:
      payment_id: payment_found.payment_id
      amount: payment_found.amount
      currency: payment_found.currency
      redirect_status: extract_params.redirect_status
      payment_intent: extract_params.payment_intent

  # Render checkout form (payment still pending)
  - id: show_checkout
    condition: payment_found.is_final != true
    type: checkout.render
    args:
      client_secret: payment_found.client_secret
      payment_id: payment_found.payment_id
      amount: payment_found.amount
      currency: payment_found.currency

  # Build final response
  - id: final_response
    type: assign
    args:
      html: >
        payment_not_found.error_html ??
        show_result.result.html ??
        show_checkout.result.html
      status_code: 'payment_not_found.error_html != null ? 404 : 200'

return:
  type: http.html
  args:
    status: final_response.status_code
    body: final_response.html
